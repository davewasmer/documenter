"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const fs_1 = require("fs");
const lodash_1 = require("lodash");
const walk = require("walk-sync");
const requireDir = require("require-dir");
const glob_1 = require("glob");
const createDebug = require("debug");
const debug = createDebug('documenter:documenter');
const extractersDir = path.join(__dirname, 'extracters');
class Extracter {
    constructor(options) {
        this.extracters = requireDir(extractersDir);
        lodash_1.defaults(options, this.defaultOptions(options.dir));
        debug(`Configuring for ${options.dir}`);
        Object.assign(this, options);
    }
    /**
     * Extract docs from the directory
     */
    extract() {
        debug(`Extracting docs for ${this.dir}`);
        return {
            pages: this.extractPages(),
            api: this.extractApi()
        };
    }
    extractPages() {
        let dir = path.join(this.dir, this.pagesDir);
        debug(`Extracting pages for ${this.dir} from ${dir}`);
        let files = walk(dir, { directories: false });
        return files.reduce((pages, file) => {
            debug(`Found a page: ${file}`);
            pages[file] = fs_1.readFileSync(path.join(dir, file), 'utf-8');
            return pages;
        }, {});
    }
    extractApi() {
        debug(`Extracting API for ${this.dir}`);
        let sourceType = this.detectSourceType();
        debug(`Source type for this project seems to be ${sourceType}`);
        if (!sourceType) {
            throw new Error('Cannot extract API docs from this directory: unknown source type. Source must be Typescript or JavaScript');
        }
        return this.extracters[sourceType].default.call(null, this);
    }
    detectSourceType() {
        // Typescript
        if (fs_1.existsSync(path.join(this.dir, 'tsconfig.json'))) {
            return 'typescript';
            // JavaScript
        }
        else if (glob_1.sync(path.join(this.dir, `{${this.sourceDirs.join(',')}}`, '**', '*.js'))) {
            return 'javascript';
        }
        return null;
    }
    defaultOptions(dir) {
        return {
            dir,
            pagesDir: path.join(dir, 'docs'),
            sourceDir: [path.join(dir, 'src')]
        };
    }
}
exports.default = Extracter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXh0cmFjdGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2V4dHJhY3Rlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDZCQUE2QjtBQUM3QiwyQkFBZ0U7QUFDaEUsbUNBQThDO0FBQzlDLGtDQUFrQztBQUNsQywwQ0FBMEM7QUFDMUMsK0JBQW9DO0FBRXBDLHFDQUFxQztBQUVyQyxNQUFNLEtBQUssR0FBRyxXQUFXLENBQUMsdUJBQXVCLENBQUMsQ0FBQztBQUNuRCxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxZQUFZLENBQUMsQ0FBQztBQW1DekQ7SUE4QkUsWUFBWSxPQUF5QjtRQUZyQyxlQUFVLEdBQTZDLFVBQVUsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUcvRSxpQkFBUSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ3BELEtBQUssQ0FBQyxtQkFBb0IsT0FBTyxDQUFDLEdBQUksRUFBRSxDQUFDLENBQUM7UUFDMUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDL0IsQ0FBQztJQUVEOztPQUVHO0lBQ0gsT0FBTztRQUNMLEtBQUssQ0FBQyx1QkFBd0IsSUFBSSxDQUFDLEdBQUksRUFBRSxDQUFDLENBQUM7UUFDM0MsTUFBTSxDQUFDO1lBQ0wsS0FBSyxFQUFFLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDMUIsR0FBRyxFQUFFLElBQUksQ0FBQyxVQUFVLEVBQUU7U0FDdkIsQ0FBQztJQUNKLENBQUM7SUFFRCxZQUFZO1FBQ1YsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUM3QyxLQUFLLENBQUMsd0JBQXlCLElBQUksQ0FBQyxHQUFJLFNBQVUsR0FBSSxFQUFFLENBQUMsQ0FBQztRQUMxRCxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEVBQUUsV0FBVyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7UUFDOUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUF5QixFQUFFLElBQVk7WUFDMUQsS0FBSyxDQUFDLGlCQUFrQixJQUFLLEVBQUUsQ0FBQyxDQUFDO1lBQ2pDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxpQkFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ2xELE1BQU0sQ0FBQyxLQUFLLENBQUM7UUFDZixDQUFDLEVBQXNCLEVBQUUsQ0FBQyxDQUFDO0lBQzdCLENBQUM7SUFFRCxVQUFVO1FBQ1IsS0FBSyxDQUFDLHNCQUF1QixJQUFJLENBQUMsR0FBSSxFQUFFLENBQUMsQ0FBQztRQUMxQyxJQUFJLFVBQVUsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUN6QyxLQUFLLENBQUMsNENBQTZDLFVBQVcsRUFBRSxDQUFDLENBQUM7UUFDbEUsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1lBQ2hCLE1BQU0sSUFBSSxLQUFLLENBQUMsMkdBQTJHLENBQUMsQ0FBQztRQUMvSCxDQUFDO1FBQ0QsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDOUQsQ0FBQztJQUVELGdCQUFnQjtRQUNkLGFBQWE7UUFDYixFQUFFLENBQUMsQ0FBQyxlQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2pELE1BQU0sQ0FBQyxZQUFZLENBQUM7WUFDdEIsYUFBYTtRQUNiLENBQUM7UUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsV0FBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFLLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3ZGLE1BQU0sQ0FBQyxZQUFZLENBQUM7UUFDdEIsQ0FBQztRQUNELE1BQU0sQ0FBQyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRU8sY0FBYyxDQUFDLEdBQVc7UUFDaEMsTUFBTSxDQUFDO1lBQ0wsR0FBRztZQUNILFFBQVEsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxNQUFNLENBQUM7WUFDaEMsU0FBUyxFQUFFLENBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUU7U0FDckMsQ0FBQztJQUNKLENBQUM7Q0FFRjtBQXZGRCw0QkF1RkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZXhpc3RzU3luYyBhcyBleGlzdHMsIHJlYWRGaWxlU3luYyBhcyByZWFkIH0gZnJvbSAnZnMnO1xuaW1wb3J0IHsgZGVmYXVsdHMsIERpY3Rpb25hcnkgfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0ICogYXMgd2FsayBmcm9tICd3YWxrLXN5bmMnO1xuaW1wb3J0ICogYXMgcmVxdWlyZURpciBmcm9tICdyZXF1aXJlLWRpcic7XG5pbXBvcnQgeyBzeW5jIGFzIGdsb2IgfSBmcm9tICdnbG9iJztcbmltcG9ydCBBUEkgZnJvbSAnLi9hcGknO1xuaW1wb3J0ICogYXMgY3JlYXRlRGVidWcgZnJvbSAnZGVidWcnO1xuXG5jb25zdCBkZWJ1ZyA9IGNyZWF0ZURlYnVnKCdkb2N1bWVudGVyOmRvY3VtZW50ZXInKTtcbmNvbnN0IGV4dHJhY3RlcnNEaXIgPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnZXh0cmFjdGVycycpO1xuXG5leHBvcnQgaW50ZXJmYWNlIEV4dHJhY3Rvck9wdGlvbnMge1xuICAvKipcbiAgICogVGhlIG5hbWUgb2YgdGhlIHByb2plY3Qgd2UgYXJlIGV4dHJhY3RpbmcgZG9jcyBmcm9tXG4gICAqL1xuICBwcm9qZWN0TmFtZTogc3RyaW5nO1xuICAvKipcbiAgICogVGhlIHZlcnNpb24gc3RyaW5nIG9mIHRoZSBwcm9qZWN0IHdlIGFyZSBleHRyYWN0aW5nIGRvY3MgZnJvbVxuICAgKi9cbiAgcHJvamVjdFZlcnNpb246IHN0cmluZztcbiAgLyoqXG4gICAqIFRoZSByb290IGRpcmVjdG9yeSBvZiB0aGUgcHJvamVjdCB0byBleHRyYWN0IGRvY3VtZW50YXRpb24gZnJvbVxuICAgKi9cbiAgZGlyOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBUaGUgcGF0aCB0byB0aGUgZGlyZWN0b3J5IGNvbnRhaW5pbmcgYWxsIHRoZSBQYWdlcyB0byBidWlsZCwgcmVsYXRpdmUgdG8gYGRpcmAuIERlZmF1bHRzIHRvIGBkb2NzYFxuICAgKi9cbiAgcGFnZXNEaXI/OiBzdHJpbmc7XG4gIC8qKlxuICAgKiBBbiBhcnJheSBvZiBwYXRocyB0byB0aGUgZGlyZWN0b3JpZXMgY29udGFpbmluZyB0aGUgc291cmNlIGNvZGUgdG8gZXh0cmFjdCBBUEkgZG9jcyBmcm9tLlxuICAgKiBEZWZhdWx0cyB0byBgc3JjYFxuICAgKi9cbiAgc291cmNlRGlycz86IHN0cmluZ1tdO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEV4dHJhY3RlZERvY3Mge1xuICBwYWdlczogRGljdGlvbmFyeTxzdHJpbmc+O1xuICBhcGk6IEFQSTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBFeHRyYWN0ZXJNZXRob2Qge1xuICAocm9vdERpcjogc3RyaW5nLCBzb3VyY2VEaXJzOiBzdHJpbmdbXSwgZGlyOiBzdHJpbmcpOiBBUEk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEV4dHJhY3RlciB7XG5cbiAgLyoqXG4gICAqIFRoZSBuYW1lIG9mIHRoZSBwcm9qZWN0IHdlIGFyZSBleHRyYWN0aW5nIGRvY3MgZnJvbVxuICAgKi9cbiAgcHJvamVjdE5hbWU6IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIHZlcnNpb24gc3RyaW5nIG9mIHRoZSBwcm9qZWN0IHdlIGFyZSBleHRyYWN0aW5nIGRvY3MgZnJvbVxuICAgKi9cbiAgcHJvamVjdFZlcnNpb246IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoZSBwcm9qZWN0IHRvIGV4dHJhY3QgZG9jdW1lbnRhdGlvbiBmcm9tXG4gICAqL1xuICBkaXI6IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIHBhdGggdG8gdGhlIGRpcmVjdG9yeSBjb250YWluaW5nIGFsbCB0aGUgUGFnZXMgdG8gYnVpbGQsIHJlbGF0aXZlIHRvIGBkaXJgLiBEZWZhdWx0cyB0byBgZG9jc2BcbiAgICovXG4gIHBhZ2VzRGlyOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIEFuIGFycmF5IG9mIHBhdGhzIHRvIHRoZSBkaXJlY3RvcmllcyBjb250YWluaW5nIHRoZSBzb3VyY2UgY29kZSB0byBleHRyYWN0IEFQSSBkb2NzIGZyb20uXG4gICAqIERlZmF1bHRzIHRvIGBzcmNgXG4gICAqL1xuICBzb3VyY2VEaXJzOiBzdHJpbmdbXTtcblxuICBleHRyYWN0ZXJzID0gPERpY3Rpb25hcnk8eyBkZWZhdWx0OiBFeHRyYWN0ZXJNZXRob2QgfT4+cmVxdWlyZURpcihleHRyYWN0ZXJzRGlyKTtcblxuICBjb25zdHJ1Y3RvcihvcHRpb25zOiBFeHRyYWN0b3JPcHRpb25zKSB7XG4gICAgZGVmYXVsdHMob3B0aW9ucywgdGhpcy5kZWZhdWx0T3B0aW9ucyhvcHRpb25zLmRpcikpO1xuICAgIGRlYnVnKGBDb25maWd1cmluZyBmb3IgJHsgb3B0aW9ucy5kaXIgfWApO1xuICAgIE9iamVjdC5hc3NpZ24odGhpcywgb3B0aW9ucyk7XG4gIH1cblxuICAvKipcbiAgICogRXh0cmFjdCBkb2NzIGZyb20gdGhlIGRpcmVjdG9yeVxuICAgKi9cbiAgZXh0cmFjdCgpOiBFeHRyYWN0ZWREb2NzIHtcbiAgICBkZWJ1ZyhgRXh0cmFjdGluZyBkb2NzIGZvciAkeyB0aGlzLmRpciB9YCk7XG4gICAgcmV0dXJuIHtcbiAgICAgIHBhZ2VzOiB0aGlzLmV4dHJhY3RQYWdlcygpLFxuICAgICAgYXBpOiB0aGlzLmV4dHJhY3RBcGkoKVxuICAgIH07XG4gIH1cblxuICBleHRyYWN0UGFnZXMoKTogRGljdGlvbmFyeTxzdHJpbmc+IHtcbiAgICBsZXQgZGlyID0gcGF0aC5qb2luKHRoaXMuZGlyLCB0aGlzLnBhZ2VzRGlyKTtcbiAgICBkZWJ1ZyhgRXh0cmFjdGluZyBwYWdlcyBmb3IgJHsgdGhpcy5kaXIgfSBmcm9tICR7IGRpciB9YCk7XG4gICAgbGV0IGZpbGVzID0gd2FsayhkaXIsIHsgZGlyZWN0b3JpZXM6IGZhbHNlIH0pO1xuICAgIHJldHVybiBmaWxlcy5yZWR1Y2UoKHBhZ2VzOiBEaWN0aW9uYXJ5PHN0cmluZz4sIGZpbGU6IHN0cmluZykgPT4ge1xuICAgICAgZGVidWcoYEZvdW5kIGEgcGFnZTogJHsgZmlsZSB9YCk7XG4gICAgICBwYWdlc1tmaWxlXSA9IHJlYWQocGF0aC5qb2luKGRpciwgZmlsZSksICd1dGYtOCcpO1xuICAgICAgcmV0dXJuIHBhZ2VzO1xuICAgIH0sIDxEaWN0aW9uYXJ5PHN0cmluZz4+e30pO1xuICB9XG5cbiAgZXh0cmFjdEFwaSgpOiBBUEkge1xuICAgIGRlYnVnKGBFeHRyYWN0aW5nIEFQSSBmb3IgJHsgdGhpcy5kaXIgfWApO1xuICAgIGxldCBzb3VyY2VUeXBlID0gdGhpcy5kZXRlY3RTb3VyY2VUeXBlKCk7XG4gICAgZGVidWcoYFNvdXJjZSB0eXBlIGZvciB0aGlzIHByb2plY3Qgc2VlbXMgdG8gYmUgJHsgc291cmNlVHlwZSB9YCk7XG4gICAgaWYgKCFzb3VyY2VUeXBlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBleHRyYWN0IEFQSSBkb2NzIGZyb20gdGhpcyBkaXJlY3Rvcnk6IHVua25vd24gc291cmNlIHR5cGUuIFNvdXJjZSBtdXN0IGJlIFR5cGVzY3JpcHQgb3IgSmF2YVNjcmlwdCcpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5leHRyYWN0ZXJzW3NvdXJjZVR5cGVdLmRlZmF1bHQuY2FsbChudWxsLCB0aGlzKTtcbiAgfVxuXG4gIGRldGVjdFNvdXJjZVR5cGUoKTogc3RyaW5nIHwgbnVsbCB7XG4gICAgLy8gVHlwZXNjcmlwdFxuICAgIGlmIChleGlzdHMocGF0aC5qb2luKHRoaXMuZGlyLCAndHNjb25maWcuanNvbicpKSkge1xuICAgICAgcmV0dXJuICd0eXBlc2NyaXB0JztcbiAgICAvLyBKYXZhU2NyaXB0XG4gICAgfSBlbHNlIGlmIChnbG9iKHBhdGguam9pbih0aGlzLmRpciwgYHskeyB0aGlzLnNvdXJjZURpcnMuam9pbignLCcpIH19YCwgJyoqJywgJyouanMnKSkpIHtcbiAgICAgIHJldHVybiAnamF2YXNjcmlwdCc7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgcHJpdmF0ZSBkZWZhdWx0T3B0aW9ucyhkaXI6IHN0cmluZykge1xuICAgIHJldHVybiB7XG4gICAgICBkaXIsXG4gICAgICBwYWdlc0RpcjogcGF0aC5qb2luKGRpciwgJ2RvY3MnKSxcbiAgICAgIHNvdXJjZURpcjogWyBwYXRoLmpvaW4oZGlyLCAnc3JjJykgXVxuICAgIH07XG4gIH1cblxufSJdfQ==