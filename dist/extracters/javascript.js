"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Y = require("yuidocjs");
const tmp_1 = require("tmp");
const ui_1 = require("../ui");
const createDebug = require("debug");
process.removeAllListeners('uncaughtException');
const debug = createDebug('documenter:extracter:javascript');
function extractJavaScript(extracter) {
    debug(`Extracting API from JavaScript source`);
    let yuidocOutput = runYuidoc(extracter.sourceDirs);
    return normalize(yuidocOutput, extracter);
}
exports.default = extractJavaScript;
function runYuidoc(sourceDirs) {
    debug(`Running Yuidoc to extract inline documentation`);
    let outDir = tmp_1.dirSync({ prefix: 'yuidoc-output-', unsafeCleanup: true }).name;
    let config = {
        options: {
            project: {
                options: {
                    paths: sourceDirs,
                    outdir: outDir,
                    parseOnly: true
                }
            }
        }
    };
    let yuidoc = new Y.YUIDoc(config);
    return yuidoc.run();
}
function normalize(yuidoc, extracter) {
    debug(`Transforming Yuidoc output into Documenter standard format`);
    let api = {
        name: extracter.projectName,
        version: extracter.projectVersion,
        packages: {}
    };
    yuidoc.classitems.forEach((item) => {
        let packageName = item.module;
        if (!packageName) {
            packageName = api.name;
        }
        if (!api.packages[packageName]) {
            api.packages[packageName] = {
                classes: {},
                interfaces: {},
                functions: []
            };
        }
        let pkg = api.packages[packageName];
        // Free functions
        if (!item.class && item.itemtype === 'method') {
            debug(`Normalizing free function: ${item.name}`);
            pkg.functions.push(normalizeFunction(item));
            // Class members
        }
        else {
            normalizeClassItem(pkg, item);
        }
    });
    return api;
}
function normalizeFunction(item) {
    return {
        name: item.name,
        description: item.description,
        access: item.access,
        package: item.module,
        tags: [],
        deprecated: item.deprecated,
        file: item.file,
        line: item.line,
        signatures: [
            {
                return: {
                    type: (item.return || {}).type,
                    description: (item.return || {}).description
                },
                parameters: item.params || []
            }
        ]
    };
}
function normalizeClassItem(pkg, item) {
    debug(`Normalizing class item: ${item.name}`);
    let klass = getOrAddClass(pkg, item.class);
    if (item.is_constructor) {
        populateClass(klass, item);
    }
    else if (item.class) {
        addClassMember(klass, item);
    }
    else {
        ui_1.default.warn(`Invalid classitem found: ${item.name} is not a constructor, free function, or class member. I don't know how to document that`);
    }
}
function getOrAddClass(pkg, className) {
    if (!pkg.classes[className]) {
        pkg.classes[className] = {
            name: className,
            staticProperties: {},
            staticMethods: {},
            properties: {},
            methods: {}
        };
    }
    return pkg.classes[className];
}
function populateClass(klass, item) {
    klass.name = item.name;
    klass.description = item.description;
}
function addClassMember(klass, item) {
    if (item.itemtype === 'method') {
        addClassMethod(klass, item);
    }
    else if (item.itemtype === 'property') {
        addClassProperty(klass, item);
    }
    else {
        ui_1.default.warn(`Unrecognized itemtype: ${item.itemtype}. I don't know how to document that.`);
    }
}
function addClassMethod(klass, item) {
    let method = {
        name: item.name,
        description: item.description,
        access: item.access,
        deprecated: item.deprecated,
        inherited: null,
        file: item.file,
        line: item.line,
        tags: [],
        signatures: [
            {
                parameters: item.params || [],
                return: item.return || {}
            }
        ]
    };
    if (item.static) {
        klass.staticMethods[item.name] = method;
    }
    else {
        klass.methods[item.name] = method;
    }
}
function addClassProperty(klass, item) {
    let property = {
        name: item.name,
        description: item.description,
        type: item.type,
        access: item.access,
        deprecated: item.deprecated,
        inherited: null,
        file: item.file,
        line: item.line,
        tags: [],
    };
    if (item.static) {
        klass.staticProperties[item.name] = property;
    }
    else {
        klass.properties[item.name] = property;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiamF2YXNjcmlwdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9leHRyYWN0ZXJzL2phdmFzY3JpcHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw4QkFBOEI7QUFDOUIsNkJBQXFDO0FBRXJDLDhCQUF1QjtBQUN2QixxQ0FBcUM7QUFHckMsT0FBTyxDQUFDLGtCQUFrQixDQUFDLG1CQUFtQixDQUFDLENBQUM7QUFFaEQsTUFBTSxLQUFLLEdBQUcsV0FBVyxDQUFDLGlDQUFpQyxDQUFDLENBQUM7QUFFN0QsMkJBQTBDLFNBQW9CO0lBQzVELEtBQUssQ0FBQyx1Q0FBdUMsQ0FBQyxDQUFDO0lBQy9DLElBQUksWUFBWSxHQUFHLFNBQVMsQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDbkQsTUFBTSxDQUFDLFNBQVMsQ0FBQyxZQUFZLEVBQUUsU0FBUyxDQUFDLENBQUM7QUFDNUMsQ0FBQztBQUpELG9DQUlDO0FBRUQsbUJBQW1CLFVBQW9CO0lBQ3JDLEtBQUssQ0FBQyxnREFBZ0QsQ0FBQyxDQUFDO0lBQ3hELElBQUksTUFBTSxHQUFHLGFBQUcsQ0FBQyxFQUFFLE1BQU0sRUFBRSxnQkFBZ0IsRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDekUsSUFBSSxNQUFNLEdBQUc7UUFDWCxPQUFPLEVBQUU7WUFDUCxPQUFPLEVBQUc7Z0JBQ1IsT0FBTyxFQUFFO29CQUNQLEtBQUssRUFBRSxVQUFVO29CQUNqQixNQUFNLEVBQUUsTUFBTTtvQkFDZCxTQUFTLEVBQUUsSUFBSTtpQkFDaEI7YUFDRjtTQUNGO0tBQ0YsQ0FBQztJQUNGLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNsQyxNQUFNLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDO0FBQ3RCLENBQUM7QUFFRCxtQkFBbUIsTUFBYyxFQUFFLFNBQW9CO0lB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SSxDQUFDLElBQUk7UUFDZixJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7UUFDZixJQUFJLEVBQUUsRUFBRTtLQUNULENBQUM7SUFDRixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUNoQixLQUFLLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLFFBQVEsQ0FBQztJQUMvQyxDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDTixLQUFLLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxRQUFRLENBQUM7SUFDekMsQ0FBQztBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBZIGZyb20gJ3l1aWRvY2pzJztcbmltcG9ydCB7IGRpclN5bmMgYXMgdG1wIH0gZnJvbSAndG1wJztcbmltcG9ydCBBUEksIHsgRnJlZUZ1bmN0aW9uLCBQYWNrYWdlLCBDbGFzcywgTWV0aG9kLCBQcm9wZXJ0eSB9IGZyb20gJy4uL2FwaSc7XG5pbXBvcnQgdWkgZnJvbSAnLi4vdWknO1xuaW1wb3J0ICogYXMgY3JlYXRlRGVidWcgZnJvbSAnZGVidWcnO1xuaW1wb3J0IEV4dHJhY3RlciBmcm9tICcuLi9leHRyYWN0ZXInO1xuXG5wcm9jZXNzLnJlbW92ZUFsbExpc3RlbmVycygndW5jYXVnaHRFeGNlcHRpb24nKTtcblxuY29uc3QgZGVidWcgPSBjcmVhdGVEZWJ1ZygnZG9jdW1lbnRlcjpleHRyYWN0ZXI6amF2YXNjcmlwdCcpO1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBleHRyYWN0SmF2YVNjcmlwdChleHRyYWN0ZXI6IEV4dHJhY3Rlcik6IEFQSSB7XG4gIGRlYnVnKGBFeHRyYWN0aW5nIEFQSSBmcm9tIEphdmFTY3JpcHQgc291cmNlYCk7XG4gIGxldCB5dWlkb2NPdXRwdXQgPSBydW5ZdWlkb2MoZXh0cmFjdGVyLnNvdXJjZURpcnMpO1xuICByZXR1cm4gbm9ybWFsaXplKHl1aWRvY091dHB1dCwgZXh0cmFjdGVyKTtcbn1cblxuZnVuY3Rpb24gcnVuWXVpZG9jKHNvdXJjZURpcnM6IHN0cmluZ1tdKTogWXVpZG9jIHtcbiAgZGVidWcoYFJ1bm5pbmcgWXVpZG9jIHRvIGV4dHJhY3QgaW5saW5lIGRvY3VtZW50YXRpb25gKTtcbiAgbGV0IG91dERpciA9IHRtcCh7IHByZWZpeDogJ3l1aWRvYy1vdXRwdXQtJywgdW5zYWZlQ2xlYW51cDogdHJ1ZSB9KS5uYW1lO1xuICBsZXQgY29uZmlnID0ge1xuICAgIG9wdGlvbnM6IHtcbiAgICAgIHByb2plY3QgOiB7XG4gICAgICAgIG9wdGlvbnM6IHtcbiAgICAgICAgICBwYXRoczogc291cmNlRGlycyxcbiAgICAgICAgICBvdXRkaXI6IG91dERpcixcbiAgICAgICAgICBwYXJzZU9ubHk6IHRydWVcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfTtcbiAgbGV0IHl1aWRvYyA9IG5ldyBZLllVSURvYyhjb25maWcpO1xuICByZXR1cm4geXVpZG9jLnJ1bigpO1xufVxuXG5mdW5jdGlvbiBub3JtYWxpemUoeXVpZG9jOiBZdWlkb2MsIGV4dHJhY3RlcjogRXh0cmFjdGVyKTogQVBJIHtcbiAgZGVidWcoYFRyYW5zZm9ybWluZyBZdWlkb2Mgb3V0cHV0IGludG8gRG9jdW1lbnRlciBzdGFuZGFyZCBmb3JtYXRgKTtcbiAgbGV0IGFwaTogQVBJID0ge1xuICAgIG5hbWU6IGV4dHJhY3Rlci5wcm9qZWN0TmFtZSxcbiAgICB2ZXJzaW9uOiBleHRyYWN0ZXIucHJvamVjdFZlcnNpb24sXG4gICAgcGFja2FnZXM6IHt9XG4gIH07XG4gIHl1aWRvYy5jbGFzc2l0ZW1zLmZvckVhY2goKGl0ZW0pID0+IHtcbiAgICBsZXQgcGFja2FnZU5hbWUgPSBpdGVtLm1vZHVsZTtcbiAgICBpZiAoIXBhY2thZ2VOYW1lKSB7XG4gICAgICBwYWNrYWdlTmFtZSA9IGFwaS5uYW1lXG4gICAgfVxuICAgIGlmICghYXBpLnBhY2thZ2VzW3BhY2thZ2VOYW1lXSkge1xuICAgICAgYXBpLnBhY2thZ2VzW3BhY2thZ2VOYW1lXSA9IHtcbiAgICAgICAgY2xhc3Nlczoge30sXG4gICAgICAgIGludGVyZmFjZXM6IHt9LFxuICAgICAgICBmdW5jdGlvbnM6IFtdXG4gICAgICB9O1xuICAgIH1cbiAgICBsZXQgcGtnID0gYXBpLnBhY2thZ2VzW3BhY2thZ2VOYW1lXTtcblxuICAgIC8vIEZyZWUgZnVuY3Rpb25zXG4gICAgaWYgKCFpdGVtLmNsYXNzICYmIGl0ZW0uaXRlbXR5cGUgPT09ICdtZXRob2QnKSB7XG4gICAgICBkZWJ1ZyhgTm9ybWFsaXppbmcgZnJlZSBmdW5jdGlvbjogJHsgaXRlbS5uYW1lIH1gKTtcbiAgICAgIHBrZy5mdW5jdGlvbnMucHVzaChub3JtYWxpemVGdW5jdGlvbihpdGVtKSk7XG5cbiAgICAvLyBDbGFzcyBtZW1iZXJzXG4gICAgfSBlbHNlIHtcbiAgICAgIG5vcm1hbGl6ZUNsYXNzSXRlbShwa2csIGl0ZW0pO1xuICAgIH1cblxuICB9KTtcbiAgcmV0dXJuIGFwaTtcbn1cblxuZnVuY3Rpb24gbm9ybWFsaXplRnVuY3Rpb24oaXRlbTogQ2xhc3NJdGVtKTogRnJlZUZ1bmN0aW9uIHtcbiAgcmV0dXJuIHtcbiAgICBuYW1lOiBpdGVtLm5hbWUsXG4gICAgZGVzY3JpcHRpb246IGl0ZW0uZGVzY3JpcHRpb24sXG4gICAgYWNjZXNzOiBpdGVtLmFjY2VzcyxcbiAgICBwYWNrYWdlOiBpdGVtLm1vZHVsZSxcbiAgICB0YWdzOiBbXSxcbiAgICBkZXByZWNhdGVkOiBpdGVtLmRlcHJlY2F0ZWQsXG4gICAgZmlsZTogaXRlbS5maWxlLFxuICAgIGxpbmU6IGl0ZW0ubGluZSxcbiAgICBzaWduYXR1cmVzOiBbXG4gICAgICB7XG4gICAgICAgIHJldHVybjoge1xuICAgICAgICAgIHR5cGU6IChpdGVtLnJldHVybiB8fCB7fSkudHlwZSxcbiAgICAgICAgICBkZXNjcmlwdGlvbjogKGl0ZW0ucmV0dXJuIHx8IHt9KS5kZXNjcmlwdGlvblxuICAgICAgICB9LFxuICAgICAgICBwYXJhbWV0ZXJzOiBpdGVtLnBhcmFtcyB8fCBbXVxuICAgICAgfVxuICAgIF1cbiAgfTtcbn1cblxuZnVuY3Rpb24gbm9ybWFsaXplQ2xhc3NJdGVtKHBrZzogUGFja2FnZSwgaXRlbTogQ2xhc3NJdGVtKSB7XG4gIGRlYnVnKGBOb3JtYWxpemluZyBjbGFzcyBpdGVtOiAkeyBpdGVtLm5hbWUgfWApO1xuICBsZXQga2xhc3MgPSBnZXRPckFkZENsYXNzKHBrZywgaXRlbS5jbGFzcyk7XG5cbiAgaWYgKGl0ZW0uaXNfY29uc3RydWN0b3IpIHtcbiAgICBwb3B1bGF0ZUNsYXNzKGtsYXNzLCBpdGVtKTtcbiAgfSBlbHNlIGlmIChpdGVtLmNsYXNzKSB7XG4gICAgYWRkQ2xhc3NNZW1iZXIoa2xhc3MsIGl0ZW0pO1xuICB9IGVsc2Uge1xuICAgIHVpLndhcm4oYEludmFsaWQgY2xhc3NpdGVtIGZvdW5kOiAkeyBpdGVtLm5hbWUgfSBpcyBub3QgYSBjb25zdHJ1Y3RvciwgZnJlZSBmdW5jdGlvbiwgb3IgY2xhc3MgbWVtYmVyLiBJIGRvbid0IGtub3cgaG93IHRvIGRvY3VtZW50IHRoYXRgKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRPckFkZENsYXNzKHBrZzogUGFja2FnZSwgY2xhc3NOYW1lOiBzdHJpbmcpIHtcbiAgaWYgKCFwa2cuY2xhc3Nlc1tjbGFzc05hbWVdKSB7XG4gICAgcGtnLmNsYXNzZXNbY2xhc3NOYW1lXSA9IHtcbiAgICAgIG5hbWU6IGNsYXNzTmFtZSxcbiAgICAgIHN0YXRpY1Byb3BlcnRpZXM6IHt9LFxuICAgICAgc3RhdGljTWV0aG9kczoge30sXG4gICAgICBwcm9wZXJ0aWVzOiB7fSxcbiAgICAgIG1ldGhvZHM6IHt9XG4gICAgfTtcbiAgfVxuICByZXR1cm4gcGtnLmNsYXNzZXNbY2xhc3NOYW1lXTtcbn1cblxuZnVuY3Rpb24gcG9wdWxhdGVDbGFzcyhrbGFzczogQ2xhc3MsIGl0ZW06IENsYXNzSXRlbSkge1xuICBrbGFzcy5uYW1lID0gaXRlbS5uYW1lO1xuICBrbGFzcy5kZXNjcmlwdGlvbiA9IGl0ZW0uZGVzY3JpcHRpb247XG59XG5cbmZ1bmN0aW9uIGFkZENsYXNzTWVtYmVyKGtsYXNzOiBDbGFzcywgaXRlbTogQ2xhc3NJdGVtKSB7XG4gIGlmIChpdGVtLml0ZW10eXBlID09PSAnbWV0aG9kJykge1xuICAgIGFkZENsYXNzTWV0aG9kKGtsYXNzLCBpdGVtKTtcbiAgfSBlbHNlIGlmIChpdGVtLml0ZW10eXBlID09PSAncHJvcGVydHknKSB7XG4gICAgYWRkQ2xhc3NQcm9wZXJ0eShrbGFzcywgaXRlbSk7XG4gIH0gZWxzZSB7XG4gICAgdWkud2FybihgVW5yZWNvZ25pemVkIGl0ZW10eXBlOiAkeyBpdGVtLml0ZW10eXBlIH0uIEkgZG9uJ3Qga25vdyBob3cgdG8gZG9jdW1lbnQgdGhhdC5gKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBhZGRDbGFzc01ldGhvZChrbGFzczogQ2xhc3MsIGl0ZW06IENsYXNzSXRlbSkge1xuICBsZXQgbWV0aG9kOiBNZXRob2QgPSB7XG4gICAgbmFtZTogaXRlbS5uYW1lLFxuICAgIGRlc2NyaXB0aW9uOiBpdGVtLmRlc2NyaXB0aW9uLFxuICAgIGFjY2VzczogaXRlbS5hY2Nlc3MsXG4gICAgZGVwcmVjYXRlZDogaXRlbS5kZXByZWNhdGVkLFxuICAgIGluaGVyaXRlZDogbnVsbCxcbiAgICBmaWxlOiBpdGVtLmZpbGUsXG4gICAgbGluZTogaXRlbS5saW5lLFxuICAgIHRhZ3M6IFtdLFxuICAgIHNpZ25hdHVyZXM6IFtcbiAgICAgIHtcbiAgICAgICAgcGFyYW1ldGVyczogaXRlbS5wYXJhbXMgfHwgW10sXG4gICAgICAgIHJldHVybjogaXRlbS5yZXR1cm4gfHwge31cbiAgICAgIH1cbiAgICBdXG4gIH07XG4gIGlmIChpdGVtLnN0YXRpYykge1xuICAgIGtsYXNzLnN0YXRpY01ldGhvZHNbaXRlbS5uYW1lXSA9IG1ldGhvZDtcbiAgfSBlbHNlIHtcbiAgICBrbGFzcy5tZXRob2RzW2l0ZW0ubmFtZV0gPSBtZXRob2Q7XG4gIH1cbn1cblxuZnVuY3Rpb24gYWRkQ2xhc3NQcm9wZXJ0eShrbGFzczogQ2xhc3MsIGl0ZW06IENsYXNzSXRlbSkge1xuICBsZXQgcHJvcGVydHk6IFByb3BlcnR5ID0ge1xuICAgIG5hbWU6IGl0ZW0ubmFtZSxcbiAgICBkZXNjcmlwdGlvbjogaXRlbS5kZXNjcmlwdGlvbixcbiAgICB0eXBlOiBpdGVtLnR5cGUsXG4gICAgYWNjZXNzOiBpdGVtLmFjY2VzcyxcbiAgICBkZXByZWNhdGVkOiBpdGVtLmRlcHJlY2F0ZWQsXG4gICAgaW5oZXJpdGVkOiBudWxsLFxuICAgIGZpbGU6IGl0ZW0uZmlsZSxcbiAgICBsaW5lOiBpdGVtLmxpbmUsXG4gICAgdGFnczogW10sXG4gIH07XG4gIGlmIChpdGVtLnN0YXRpYykge1xuICAgIGtsYXNzLnN0YXRpY1Byb3BlcnRpZXNbaXRlbS5uYW1lXSA9IHByb3BlcnR5O1xuICB9IGVsc2Uge1xuICAgIGtsYXNzLnByb3BlcnRpZXNbaXRlbS5uYW1lXSA9IHByb3BlcnR5O1xuICB9XG59XG5cbmludGVyZmFjZSBZdWlkb2Mge1xuICBwcm9qZWN0OiB7XG4gICAgbmFtZTogc3RyaW5nO1xuICB9O1xuICBjbGFzc2l0ZW1zOiBDbGFzc0l0ZW1bXTtcbn1cblxuaW50ZXJmYWNlIFBhcmFtIHtcbiAgbmFtZTogc3RyaW5nO1xuICBkZXNjcmlwdGlvbj86IHN0cmluZztcbiAgdHlwZT86IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIENsYXNzSXRlbSB7XG4gIGZpbGU6IHN0cmluZztcbiAgbGluZTogbnVtYmVyO1xuICBkZXNjcmlwdGlvbjogc3RyaW5nO1xuICBjbGFzczogc3RyaW5nO1xuICBtb2R1bGU/OiBzdHJpbmc7XG4gIGl0ZW10eXBlPzogJ21haW4nIHwgJ21ldGhvZCcgfCAncHJvcGVydHknO1xuICBuYW1lOiBzdHJpbmc7XG4gIGFjY2Vzcz86IHN0cmluZztcbiAgcGFyYW1zPzogUGFyYW1bXTtcbiAgYXN5bmM/OiAxO1xuICB0eXBlPzogc3RyaW5nO1xuICBkZXByZWNhdGVkPzogdHJ1ZTtcbiAgaXNfY29uc3RydWN0b3I/OiAxO1xuICBzdGF0aWM/OiAxO1xuICB0aHJvd3M/OiB7XG4gICAgdHlwZT86IHN0cmluZztcbiAgICBkZXNjcmlwdGlvbj86IHN0cmluZztcbiAgfTtcbiAgcmV0dXJuPzoge1xuICAgIGRlc2NyaXB0aW9uPzogc3RyaW5nO1xuICAgIHR5cGU/OiBzdHJpbmc7XG4gIH1cbn0iXX0=