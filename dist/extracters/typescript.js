"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const typedoc_1 = require("typedoc");
const ui_1 = require("../ui");
const createDebug = require("debug");
const debug = createDebug('documenter:extracter:typescript');
function extractTypescript(extracter) {
    debug(`Extracting API from Typescript source`);
    let typedocOutput = runTypedoc(extracter.dir, extracter.sourceDirs);
    return normalize(typedocOutput, extracter);
}
exports.default = extractTypescript;
function runTypedoc(rootDir, sourceDirs) {
    debug(`Running Typedoc to extract inline documentation from ${sourceDirs}`);
    let originalDir = process.cwd();
    process.chdir(rootDir);
    let app = new typedoc_1.Application({ tsconfig: path.join(rootDir, 'tsconfig.json'), ignoreCompilerErrors: true });
    let result = app.convert(sourceDirs.map((dir) => dir + '/index.ts'));
    process.chdir(originalDir);
    return result;
}
function normalize(project, extracter) {
    debug(`Transforming Typedoc output into Documenter standard format`);
    let api = {
        name: extracter.projectName,
        version: extracter.projectVersion,
        packages: {},
    };
    project.children.forEach((file) => {
        (file.children || []).forEach((item) => {
            if (item.flags.isExported) {
                let packageName = getPackageName(item);
                if (!packageName) {
                    packageName = api.name;
                }
                if (!api.packages[packageName]) {
                    api.packages[packageName] = {
                        classes: {},
                        interfaces: {},
                        functions: []
                    };
                }
                let pkg = api.packages[packageName];
                // Free functions
                if (item.kindString === 'Function') {
                    debug(`normalizing ${item.name} as function`);
                    pkg.functions.push(normalizeMethod(item));
                    // Interfaces
                }
                else if (item.kindString === 'Interface') {
                    debug(`normalizing ${item.name} as interface`);
                    pkg.interfaces[item.name] = normalizeInterface(item);
                    // Classes
                }
                else if (item.kindString === 'Class') {
                    debug(`normalizing ${item.name} as class`);
                    pkg.classes[item.name] = normalizeClass(item);
                }
                else {
                    ui_1.default.warn(`${item.sources[0].fileName} exported a ${item.kindString}, and I don't know how to document that`);
                }
            }
        });
    });
    return api;
}
function normalizeMethod(item) {
    let method = normalizeCommon(item);
    method.signatures = normalizeSignatures(item.signatures);
    return method;
}
function normalizeInterface(item) {
    return {
        name: item.name,
        description: item.comment && item.comment.text,
        properties: normalizeProperties(item.children, false),
        methods: normalizeMethods(item.children, false)
    };
}
function normalizeClass(item) {
    return {
        name: item.name,
        description: item.comment && item.comment.text,
        staticProperties: normalizeProperties(item.children, true),
        staticMethods: normalizeMethods(item.children, true),
        properties: normalizeProperties(item.children, false),
        methods: normalizeMethods(item.children, false)
    };
}
function normalizeProperties(children, isStatic) {
    if (!children) {
        return {};
    }
    return children.reduce((properties, child) => {
        if (child.flags.isStatic === isStatic) {
            if (child.kindString === 'Property') {
                properties[child.name] = normalizeProperty(child);
            }
            else if (child.kindString === 'Accessor' && child.getSignature) {
                properties[child.name] = normalizeAccessor(child);
            }
        }
        return properties;
    }, {});
}
function normalizeProperty(item) {
    let property = normalizeCommon(item);
    property.type = displayTypeFrom(item.type);
    return property;
}
function normalizeAccessor(item) {
    let property = normalizeCommon(item);
    property.type = displayTypeFrom(item.getSignature.type);
    return property;
}
function normalizeMethods(children, isStatic) {
    if (!children) {
        return {};
    }
    return children.reduce((methods, child) => {
        if (child.flags.isStatic === isStatic && child.kindString === 'Method') {
            methods[child.name] = normalizeMethod(child);
        }
        return methods;
    }, {});
}
function normalizeSignatures(signatures) {
    return signatures.map((signature) => {
        return {
            parameters: (signature.parameters || []).map((param) => {
                return {
                    type: displayTypeFrom(param.type),
                    name: param.name,
                    description: param.comment && param.comment.text
                };
            }),
            return: {
                type: displayTypeFrom(signature.type),
                description: signature.comment && signature.comment.returns
            }
        };
    });
}
function normalizeCommon(item) {
    return {
        name: item.name,
        description: item.comment && item.comment.text,
        access: getAccess(item),
        deprecated: isDeprecated(item),
        inherited: Boolean(item.inheritedFrom),
        file: item.sources[0].fileName,
        line: item.sources[0].line,
        tags: getTags(item)
    };
}
function getAccess(item) {
    if (item.flags.isProtected) {
        return 'protected';
    }
    else if (item.flags.isPrivate) {
        return 'private';
    }
    else {
        return 'public';
    }
}
function getPackageName(item) {
    let tags = getTags(item);
    let pkgTag = tags.find((t) => t.name === 'package');
    if (pkgTag) {
        return pkgTag.value;
    }
}
function getTags(item) {
    if (item.comment && item.comment.tags) {
        return item.comment.tags.map((tag) => {
            return {
                name: tag.tagName,
                value: tag.text && tag.text.trim() || true
            };
        });
    }
    return [];
}
function isDeprecated(item) {
    let tags = getTags(item);
    let deprecationTag = tags.find((t) => t.name === 'deprecated');
    return deprecationTag && deprecationTag.value || false;
}
function displayTypeFrom(type) {
    // Recurse into array types to render the actual type that makes up the array
    if (type.elementType) {
        return displayTypeFrom(type.elementType) + '[]';
    }
    // It's a literal, inline type definition, i.e. foo: { bar: boolean }
    if (type.declaration) {
        // TODO ideally we would actually render this type, but that's pretty complicated, so skipping for now
        return 'inline literal';
    }
    let displayType = type.name;
    // If it's a reference type (i.e. not a primitive like string), use the
    // actual definition name, not the name that is local to this file
    if (type.reflection) {
        displayType = type.reflection.name;
    }
    // Add any type args it might take, recursing into those types to render them properly
    if (type.typeArguments) {
        displayType += '<' + type.typeArguments.map(displayTypeFrom).join(', ') + '>';
    }
    return displayType;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHlwZXNjcmlwdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9leHRyYWN0ZXJzL3R5cGVzY3JpcHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2QkFBNkI7QUFDN0IscUNBQXlEO0FBRXpELDhCQUF1QjtBQUN2QixxQ0FBcUM7QUFJckMsTUFBTSxLQUFLLEdBQUcsV0FBVyxDQUFDLGlDQUFpQyxDQUFDLENBQUM7QUFFN0QsMkJBQTBDLFNBQW9CO0lBQzVELEtBQUssQ0FBQyx1Q0FBdUMsQ0FBQyxDQUFDO0lBQy9DLElBQUksYUFBYSxHQUFHLFVBQVUsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLFNBQVMsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNwRSxNQUFNLENBQUMsU0FBUyxDQUFDLGFBQWEsRUFBRSxTQUFTLENBQUMsQ0FBQztBQUM3QyxDQUFDO0FBSkQsb0NBSUM7QUFFRCxvQkFBb0IsT0FBZSxFQUFFLFVBQW9CO0lBQ3ZELEtBQUssQ0FBQyx3REFBeUQsVUFBVyxFQUFFLENBQUMsQ0FBQztJQUM5RSxJQUFJLFdBQVcsR0FBRyxPQUFPLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDaEMsT0FBTyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUN2QixJQUFJLEdBQUcsR0FBRyxJQUFJLHFCQUFXLENBQUMsRUFBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsZUFBZSxDQUFDLEVBQUUsb0JBQW9CLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztJQUN6RyxJQUFJLE1BQU0sR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEtBQUssR0FBRyxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUM7SUFDckUsT0FBTyxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUMzQixNQUFNLENBQUMsTUFBTSxDQUFDO0FBQ2hCLENBQUM7QUFF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RjtJQUN0RixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztRQUN2QixXQUFXLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLENBQUM7SUFDaEYsQ0FBQztJQUVELE1BQU0sQ0FBQyxXQUFXLENBQUM7QUFDckIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBBcHBsaWNhdGlvbiwgUHJvamVjdFJlZmxlY3Rpb24gfSBmcm9tICd0eXBlZG9jJztcbmltcG9ydCBBUEksIHsgQ2xhc3MsIE1ldGhvZCwgUHJvcGVydHksIFRhZywgTWV0aG9kU2lnbmF0dXJlLCBJbnRlcmZhY2UgfSBmcm9tICcuLi9hcGknO1xuaW1wb3J0IHVpIGZyb20gJy4uL3VpJztcbmltcG9ydCAqIGFzIGNyZWF0ZURlYnVnIGZyb20gJ2RlYnVnJztcbmltcG9ydCB7IERlY2xhcmF0aW9uUmVmbGVjdGlvbiwgU2lnbmF0dXJlUmVmbGVjdGlvbiB9IGZyb20gXCJ0eXBlZG9jL2Rpc3QvbGliL21vZGVsc1wiO1xuaW1wb3J0IEV4dHJhY3RlciBmcm9tICcuLi9leHRyYWN0ZXInO1xuXG5jb25zdCBkZWJ1ZyA9IGNyZWF0ZURlYnVnKCdkb2N1bWVudGVyOmV4dHJhY3Rlcjp0eXBlc2NyaXB0Jyk7XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGV4dHJhY3RUeXBlc2NyaXB0KGV4dHJhY3RlcjogRXh0cmFjdGVyKTogQVBJIHtcbiAgZGVidWcoYEV4dHJhY3RpbmcgQVBJIGZyb20gVHlwZXNjcmlwdCBzb3VyY2VgKTtcbiAgbGV0IHR5cGVkb2NPdXRwdXQgPSBydW5UeXBlZG9jKGV4dHJhY3Rlci5kaXIsIGV4dHJhY3Rlci5zb3VyY2VEaXJzKTtcbiAgcmV0dXJuIG5vcm1hbGl6ZSh0eXBlZG9jT3V0cHV0LCBleHRyYWN0ZXIpO1xufVxuXG5mdW5jdGlvbiBydW5UeXBlZG9jKHJvb3REaXI6IHN0cmluZywgc291cmNlRGlyczogc3RyaW5nW10pIHtcbiAgZGVidWcoYFJ1bm5pbmcgVHlwZWRvYyB0byBleHRyYWN0IGlubGluZSBkb2N1bWVudGF0aW9uIGZyb20gJHsgc291cmNlRGlycyB9YCk7XG4gIGxldCBvcmlnaW5hbERpciA9IHByb2Nlc3MuY3dkKCk7XG4gIHByb2Nlc3MuY2hkaXIocm9vdERpcik7XG4gIGxldCBhcHAgPSBuZXcgQXBwbGljYXRpb24oeyB0c2NvbmZpZzogcGF0aC5qb2luKHJvb3REaXIsICd0c2NvbmZpZy5qc29uJyksIGlnbm9yZUNvbXBpbGVyRXJyb3JzOiB0cnVlIH0pOyBcbiAgbGV0IHJlc3VsdCA9IGFwcC5jb252ZXJ0KHNvdXJjZURpcnMubWFwKChkaXIpID0+IGRpciArICcvaW5kZXgudHMnKSk7XG4gIHByb2Nlc3MuY2hkaXIob3JpZ2luYWxEaXIpO1xuICByZXR1cm4gcmVzdWx0O1xufVxuXG5mdW5jdGlvbiBub3JtYWxpemUocHJvamVjdDogUHJvamVjdFJlZmxlY3Rpb24sIGV4dHJhY3RlcjogRXh0cmFjdGVyKTogQVBJIHtcbiAgZGVidWcoYFRyYW5zZm9ybWluZyBUeXBlZG9jIG91dHB1dCBpbnRvIERvY3VtZW50ZXIgc3RhbmRhcmQgZm9ybWF0YCk7XG4gIGxldCBhcGk6IEFQSSA9IHtcbiAgICBuYW1lOiBleHRyYWN0ZXIucHJvamVjdE5hbWUsXG4gICAgdmVyc2lvbjogZXh0cmFjdGVyLnByb2plY3RWZXJzaW9uLFxuICAgIHBhY2thZ2VzOiB7fSxcbiAgfTtcbiAgcHJvamVjdC5jaGlsZHJlbi5mb3JFYWNoKChmaWxlKSA9PiB7XG4gICAgKGZpbGUuY2hpbGRyZW58fCBbXSkuZm9yRWFjaCgoaXRlbSkgPT4ge1xuICAgICAgaWYgKGl0ZW0uZmxhZ3MuaXNFeHBvcnRlZCkge1xuICAgICAgICBsZXQgcGFja2FnZU5hbWUgPSBnZXRQYWNrYWdlTmFtZShpdGVtKTtcbiAgICAgICAgaWYgKCFwYWNrYWdlTmFtZSkge1xuICAgICAgICAgIHBhY2thZ2VOYW1lID0gYXBpLm5hbWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFhcGkucGFja2FnZXNbcGFja2FnZU5hbWVdKSB7XG4gICAgICAgICAgYXBpLnBhY2thZ2VzW3BhY2thZ2VOYW1lXSA9IHtcbiAgICAgICAgICAgIGNsYXNzZXM6IHt9LFxuICAgICAgICAgICAgaW50ZXJmYWNlczoge30sXG4gICAgICAgICAgICBmdW5jdGlvbnM6IFtdXG4gICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgICBsZXQgcGtnID0gYXBpLnBhY2thZ2VzW3BhY2thZ2VOYW1lXTtcblxuICAgICAgICAvLyBGcmVlIGZ1bmN0aW9uc1xuICAgICAgICBpZiAoaXRlbS5raW5kU3RyaW5nID09PSAnRnVuY3Rpb24nKSB7XG4gICAgICAgICAgZGVidWcoYG5vcm1hbGl6aW5nICR7IGl0ZW0ubmFtZSB9IGFzIGZ1bmN0aW9uYCk7XG4gICAgICAgICAgcGtnLmZ1bmN0aW9ucy5wdXNoKG5vcm1hbGl6ZU1ldGhvZChpdGVtKSk7XG5cbiAgICAgICAgLy8gSW50ZXJmYWNlc1xuICAgICAgICB9IGVsc2UgaWYgKGl0ZW0ua2luZFN0cmluZyA9PT0gJ0ludGVyZmFjZScpIHtcbiAgICAgICAgICBkZWJ1Zyhgbm9ybWFsaXppbmcgJHsgaXRlbS5uYW1lIH0gYXMgaW50ZXJmYWNlYCk7XG4gICAgICAgICAgcGtnLmludGVyZmFjZXNbaXRlbS5uYW1lXSA9IG5vcm1hbGl6ZUludGVyZmFjZShpdGVtKTtcblxuICAgICAgICAvLyBDbGFzc2VzXG4gICAgICAgIH0gZWxzZSBpZiAoaXRlbS5raW5kU3RyaW5nID09PSAnQ2xhc3MnKSB7XG4gICAgICAgICAgZGVidWcoYG5vcm1hbGl6aW5nICR7IGl0ZW0ubmFtZSB9IGFzIGNsYXNzYCk7XG4gICAgICAgICAgcGtnLmNsYXNzZXNbaXRlbS5uYW1lXSA9IG5vcm1hbGl6ZUNsYXNzKGl0ZW0pO1xuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdWkud2FybihgJHsgaXRlbS5zb3VyY2VzWzBdLmZpbGVOYW1lIH0gZXhwb3J0ZWQgYSAkeyBpdGVtLmtpbmRTdHJpbmcgfSwgYW5kIEkgZG9uJ3Qga25vdyBob3cgdG8gZG9jdW1lbnQgdGhhdGApO1xuICAgICAgICB9XG5cbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG4gIHJldHVybiBhcGk7XG59XG5cbmZ1bmN0aW9uIG5vcm1hbGl6ZU1ldGhvZChpdGVtOiBEZWNsYXJhdGlvblJlZmxlY3Rpb24pOiBNZXRob2Qge1xuICBsZXQgbWV0aG9kID0gPE1ldGhvZD5ub3JtYWxpemVDb21tb24oaXRlbSk7XG4gIG1ldGhvZC5zaWduYXR1cmVzID0gbm9ybWFsaXplU2lnbmF0dXJlcyhpdGVtLnNpZ25hdHVyZXMpO1xuICByZXR1cm4gbWV0aG9kO1xufVxuXG5mdW5jdGlvbiBub3JtYWxpemVJbnRlcmZhY2UoaXRlbTogRGVjbGFyYXRpb25SZWZsZWN0aW9uKTogSW50ZXJmYWNlIHtcbiAgcmV0dXJuIHtcbiAgICBuYW1lOiBpdGVtLm5hbWUsXG4gICAgZGVzY3JpcHRpb246IGl0ZW0uY29tbWVudCAmJiBpdGVtLmNvbW1lbnQudGV4dCxcbiAgICBwcm9wZXJ0aWVzOiBub3JtYWxpemVQcm9wZXJ0aWVzKGl0ZW0uY2hpbGRyZW4sIGZhbHNlKSxcbiAgICBtZXRob2RzOiBub3JtYWxpemVNZXRob2RzKGl0ZW0uY2hpbGRyZW4sIGZhbHNlKVxuICB9O1xufVxuXG5mdW5jdGlvbiBub3JtYWxpemVDbGFzcyhpdGVtOiBEZWNsYXJhdGlvblJlZmxlY3Rpb24pOiBDbGFzcyB7XG4gIHJldHVybiB7XG4gICAgbmFtZTogaXRlbS5uYW1lLFxuICAgIGRlc2NyaXB0aW9uOiBpdGVtLmNvbW1lbnQgJiYgaXRlbS5jb21tZW50LnRleHQsXG4gICAgc3RhdGljUHJvcGVydGllczogbm9ybWFsaXplUHJvcGVydGllcyhpdGVtLmNoaWxkcmVuLCB0cnVlKSxcbiAgICBzdGF0aWNNZXRob2RzOiBub3JtYWxpemVNZXRob2RzKGl0ZW0uY2hpbGRyZW4sIHRydWUpLFxuICAgIHByb3BlcnRpZXM6IG5vcm1hbGl6ZVByb3BlcnRpZXMoaXRlbS5jaGlsZHJlbiwgZmFsc2UpLFxuICAgIG1ldGhvZHM6IG5vcm1hbGl6ZU1ldGhvZHMoaXRlbS5jaGlsZHJlbiwgZmFsc2UpXG4gIH07XG59XG5cbmZ1bmN0aW9uIG5vcm1hbGl6ZVByb3BlcnRpZXMoY2hpbGRyZW46IERlY2xhcmF0aW9uUmVmbGVjdGlvbltdLCBpc1N0YXRpYzogYm9vbGVhbikge1xuICBpZiAoIWNoaWxkcmVuKSB7XG4gICAgcmV0dXJuIHt9O1xuICB9XG4gIHJldHVybiBjaGlsZHJlbi5yZWR1Y2UoKHByb3BlcnRpZXMsIGNoaWxkKSA9PiB7XG4gICAgaWYgKGNoaWxkLmZsYWdzLmlzU3RhdGljID09PSBpc1N0YXRpYykge1xuICAgICAgaWYgKGNoaWxkLmtpbmRTdHJpbmcgPT09ICdQcm9wZXJ0eScpIHtcbiAgICAgICAgcHJvcGVydGllc1tjaGlsZC5uYW1lXSA9IG5vcm1hbGl6ZVByb3BlcnR5KGNoaWxkKTtcbiAgICAgIH0gZWxzZSBpZiAoY2hpbGQua2luZFN0cmluZyA9PT0gJ0FjY2Vzc29yJyAmJiBjaGlsZC5nZXRTaWduYXR1cmUpIHtcbiAgICAgICAgcHJvcGVydGllc1tjaGlsZC5uYW1lXSA9IG5vcm1hbGl6ZUFjY2Vzc29yKGNoaWxkKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHByb3BlcnRpZXM7XG4gIH0sIDx7IFtwcm9wZXJ0eU5hbWU6IHN0cmluZ106IFByb3BlcnR5IH0+e30pO1xufVxuXG5mdW5jdGlvbiBub3JtYWxpemVQcm9wZXJ0eShpdGVtOiBEZWNsYXJhdGlvblJlZmxlY3Rpb24pOiBQcm9wZXJ0eSB7XG4gIGxldCBwcm9wZXJ0eSA9IDxQcm9wZXJ0eT5ub3JtYWxpemVDb21tb24oaXRlbSk7XG4gIHByb3BlcnR5LnR5cGUgPSBkaXNwbGF5VHlwZUZyb20oaXRlbS50eXBlKTtcbiAgcmV0dXJuIHByb3BlcnR5O1xufVxuXG5mdW5jdGlvbiBub3JtYWxpemVBY2Nlc3NvcihpdGVtOiBEZWNsYXJhdGlvblJlZmxlY3Rpb24pOiBQcm9wZXJ0eSB7XG4gIGxldCBwcm9wZXJ0eSA9IDxQcm9wZXJ0eT5ub3JtYWxpemVDb21tb24oaXRlbSk7XG4gIHByb3BlcnR5LnR5cGUgPSBkaXNwbGF5VHlwZUZyb20oaXRlbS5nZXRTaWduYXR1cmUudHlwZSk7XG4gIHJldHVybiBwcm9wZXJ0eTtcbn1cblxuZnVuY3Rpb24gbm9ybWFsaXplTWV0aG9kcyhjaGlsZHJlbjogRGVjbGFyYXRpb25SZWZsZWN0aW9uW10sIGlzU3RhdGljOiBib29sZWFuKSB7XG4gIGlmICghY2hpbGRyZW4pIHtcbiAgICByZXR1cm4ge307XG4gIH1cbiAgcmV0dXJuIGNoaWxkcmVuLnJlZHVjZSgobWV0aG9kcywgY2hpbGQpID0+IHtcbiAgICBpZiAoY2hpbGQuZmxhZ3MuaXNTdGF0aWMgPT09IGlzU3RhdGljICYmIGNoaWxkLmtpbmRTdHJpbmcgPT09ICdNZXRob2QnKSB7XG4gICAgICBtZXRob2RzW2NoaWxkLm5hbWVdID0gbm9ybWFsaXplTWV0aG9kKGNoaWxkKTtcbiAgICB9XG4gICAgcmV0dXJuIG1ldGhvZHM7XG4gIH0sIDx7IFttZXRob2ROYW1lOiBzdHJpbmddOiBNZXRob2QgfT57fSk7XG59XG5cbmZ1bmN0aW9uIG5vcm1hbGl6ZVNpZ25hdHVyZXMoc2lnbmF0dXJlczogU2lnbmF0dXJlUmVmbGVjdGlvbltdKTogTWV0aG9kU2lnbmF0dXJlW10ge1xuICByZXR1cm4gc2lnbmF0dXJlcy5tYXAoKHNpZ25hdHVyZSkgPT4ge1xuICAgIHJldHVybiB7XG4gICAgICBwYXJhbWV0ZXJzOiAoc2lnbmF0dXJlLnBhcmFtZXRlcnMgfHwgW10pLm1hcCgocGFyYW0pID0+IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB0eXBlOiBkaXNwbGF5VHlwZUZyb20ocGFyYW0udHlwZSksXG4gICAgICAgICAgbmFtZTogcGFyYW0ubmFtZSxcbiAgICAgICAgICBkZXNjcmlwdGlvbjogcGFyYW0uY29tbWVudCAmJiBwYXJhbS5jb21tZW50LnRleHRcbiAgICAgICAgfVxuICAgICAgfSksXG4gICAgICByZXR1cm46IHtcbiAgICAgICAgdHlwZTogZGlzcGxheVR5cGVGcm9tKHNpZ25hdHVyZS50eXBlKSxcbiAgICAgICAgZGVzY3JpcHRpb246IHNpZ25hdHVyZS5jb21tZW50ICYmIHNpZ25hdHVyZS5jb21tZW50LnJldHVybnNcbiAgICAgIH1cbiAgICB9O1xuICB9KVxufVxuXG5mdW5jdGlvbiBub3JtYWxpemVDb21tb24oaXRlbTogRGVjbGFyYXRpb25SZWZsZWN0aW9uKSB7XG4gIHJldHVybiB7XG4gICAgbmFtZTogaXRlbS5uYW1lLFxuICAgIGRlc2NyaXB0aW9uOiBpdGVtLmNvbW1lbnQgJiYgaXRlbS5jb21tZW50LnRleHQsXG4gICAgYWNjZXNzOiBnZXRBY2Nlc3MoaXRlbSksXG4gICAgZGVwcmVjYXRlZDogaXNEZXByZWNhdGVkKGl0ZW0pLFxuICAgIGluaGVyaXRlZDogQm9vbGVhbihpdGVtLmluaGVyaXRlZEZyb20pLFxuICAgIGZpbGU6IGl0ZW0uc291cmNlc1swXS5maWxlTmFtZSxcbiAgICBsaW5lOiBpdGVtLnNvdXJjZXNbMF0ubGluZSxcbiAgICB0YWdzOiBnZXRUYWdzKGl0ZW0pXG4gIH07XG59XG5cbmZ1bmN0aW9uIGdldEFjY2VzcyhpdGVtOiBEZWNsYXJhdGlvblJlZmxlY3Rpb24pOiBzdHJpbmcge1xuICBpZiAoaXRlbS5mbGFncy5pc1Byb3RlY3RlZCkge1xuICAgIHJldHVybiAncHJvdGVjdGVkJztcbiAgfSBlbHNlIGlmIChpdGVtLmZsYWdzLmlzUHJpdmF0ZSkge1xuICAgIHJldHVybiAncHJpdmF0ZSc7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuICdwdWJsaWMnO1xuICB9XG59XG5cbmZ1bmN0aW9uIGdldFBhY2thZ2VOYW1lKGl0ZW06IERlY2xhcmF0aW9uUmVmbGVjdGlvbik6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gIGxldCB0YWdzID0gZ2V0VGFncyhpdGVtKTtcbiAgbGV0IHBrZ1RhZyA9IHRhZ3MuZmluZCgodCkgPT4gdC5uYW1lID09PSAncGFja2FnZScpO1xuICBpZiAocGtnVGFnKSB7XG4gICAgcmV0dXJuIDxzdHJpbmc+cGtnVGFnLnZhbHVlO1xuICB9XG59XG5cbmZ1bmN0aW9uIGdldFRhZ3MoaXRlbTogRGVjbGFyYXRpb25SZWZsZWN0aW9uKTogVGFnW10ge1xuICBpZiAoaXRlbS5jb21tZW50ICYmIGl0ZW0uY29tbWVudC50YWdzKSB7XG4gICAgcmV0dXJuIGl0ZW0uY29tbWVudC50YWdzLm1hcCgodGFnKSA9PiB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBuYW1lOiB0YWcudGFnTmFtZSxcbiAgICAgICAgdmFsdWU6IHRhZy50ZXh0ICYmIHRhZy50ZXh0LnRyaW0oKSB8fCB0cnVlXG4gICAgICB9O1xuICAgIH0pO1xuICB9XG4gIHJldHVybiBbXTtcbn1cblxuZnVuY3Rpb24gaXNEZXByZWNhdGVkKGl0ZW06IERlY2xhcmF0aW9uUmVmbGVjdGlvbik6IHN0cmluZyB8IGJvb2xlYW4ge1xuICBsZXQgdGFncyA9IGdldFRhZ3MoaXRlbSk7XG4gIGxldCBkZXByZWNhdGlvblRhZyA9IHRhZ3MuZmluZCgodCkgPT4gdC5uYW1lID09PSAnZGVwcmVjYXRlZCcpO1xuICByZXR1cm4gZGVwcmVjYXRpb25UYWcgJiYgZGVwcmVjYXRpb25UYWcudmFsdWUgfHwgZmFsc2U7XG59XG5cbmZ1bmN0aW9uIGRpc3BsYXlUeXBlRnJvbSh0eXBlOiBhbnkpOiBzdHJpbmcge1xuICAvLyBSZWN1cnNlIGludG8gYXJyYXkgdHlwZXMgdG8gcmVuZGVyIHRoZSBhY3R1YWwgdHlwZSB0aGF0IG1ha2VzIHVwIHRoZSBhcnJheVxuICBpZiAodHlwZS5lbGVtZW50VHlwZSkge1xuICAgIHJldHVybiBkaXNwbGF5VHlwZUZyb20odHlwZS5lbGVtZW50VHlwZSkgKyAnW10nO1xuICB9XG5cbiAgLy8gSXQncyBhIGxpdGVyYWwsIGlubGluZSB0eXBlIGRlZmluaXRpb24sIGkuZS4gZm9vOiB7IGJhcjogYm9vbGVhbiB9XG4gIGlmICh0eXBlLmRlY2xhcmF0aW9uKSB7XG4gICAgLy8gVE9ETyBpZGVhbGx5IHdlIHdvdWxkIGFjdHVhbGx5IHJlbmRlciB0aGlzIHR5cGUsIGJ1dCB0aGF0J3MgcHJldHR5IGNvbXBsaWNhdGVkLCBzbyBza2lwcGluZyBmb3Igbm93XG4gICAgcmV0dXJuICdpbmxpbmUgbGl0ZXJhbCc7XG4gIH1cblxuICBsZXQgZGlzcGxheVR5cGUgPSB0eXBlLm5hbWU7XG5cbiAgLy8gSWYgaXQncyBhIHJlZmVyZW5jZSB0eXBlIChpLmUuIG5vdCBhIHByaW1pdGl2ZSBsaWtlIHN0cmluZyksIHVzZSB0aGVcbiAgLy8gYWN0dWFsIGRlZmluaXRpb24gbmFtZSwgbm90IHRoZSBuYW1lIHRoYXQgaXMgbG9jYWwgdG8gdGhpcyBmaWxlXG4gIGlmICh0eXBlLnJlZmxlY3Rpb24pIHtcbiAgICBkaXNwbGF5VHlwZSA9IHR5cGUucmVmbGVjdGlvbi5uYW1lO1xuICB9XG5cbiAgLy8gQWRkIGFueSB0eXBlIGFyZ3MgaXQgbWlnaHQgdGFrZSwgcmVjdXJzaW5nIGludG8gdGhvc2UgdHlwZXMgdG8gcmVuZGVyIHRoZW0gcHJvcGVybHlcbiAgaWYgKHR5cGUudHlwZUFyZ3VtZW50cykge1xuICAgIGRpc3BsYXlUeXBlICs9ICc8JyArIHR5cGUudHlwZUFyZ3VtZW50cy5tYXAoZGlzcGxheVR5cGVGcm9tKS5qb2luKCcsICcpICsgJz4nOyAgICBcbiAgfVxuXG4gIHJldHVybiBkaXNwbGF5VHlwZTtcbn1cblxuIl19